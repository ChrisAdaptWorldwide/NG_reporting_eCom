-- One row per session with flags for each add_to_cart_type
CREATE OR REPLACE VIEW `neogen-ga4-export.reporting_tables.eCom_itemName_atcSource_sessions` AS
WITH atc_item AS (
  SELECT
    PARSE_DATE('%Y%m%d', event_date) AS date,
    (SELECT value.string_value FROM UNNEST(event_params) WHERE key = 'market_id') AS market_id,
    SAFE_CAST(CONCAT(
      user_pseudo_id,
      CAST((SELECT value.int_value FROM UNNEST(event_params) WHERE key = 'ga_session_id') AS STRING)
    ) AS STRING) AS session_id,

    -- add_to_cart_type is stored at ITEM scope (custom param)
    (SELECT p.value.string_value FROM UNNEST(item.item_params) p WHERE p.key = 'add_to_cart_type') AS add_to_cart_type
  FROM `neogen-ga4-export.analytics_331328809.events_*`
  CROSS JOIN UNNEST(items) AS item
  WHERE
    _TABLE_SUFFIX BETWEEN '20250501'
      AND FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY))
    AND event_name = 'add_to_cart'
)

, atc_clean AS (
  SELECT
    date, market_id, session_id, add_to_cart_type
  FROM atc_item
  WHERE  add_to_cart_type IN (
      'pdp','quick_order','my_account_orders','Search','my_account_lists',
      'pcp','pdp_related','cms_product_carousel','product_recommendations'
    )
)

, session_atc_once AS (
  -- One row per session per add_to_cart_type (avoid double counting when multiple items in same session share the source)
  SELECT DISTINCT
    date, market_id, session_id, add_to_cart_type
  FROM atc_clean
)

SELECT
  date,
  market_id,
  add_to_cart_type,
  COUNT(*) AS sessions_add_to_cart -- each row above is one unique (session, type)
FROM session_atc_once
GROUP BY date, market_id, add_to_cart_type
ORDER BY date DESC, market_id, add_to_cart_type;

