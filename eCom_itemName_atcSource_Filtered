
CREATE OR REPLACE TABLE `neogen-ga4-export.reporting_tables.eCom_itemName_atcSource` AS
WITH item_events AS (
    SELECT 
        event_name,
        PARSE_DATE('%Y%m%d', event_date) AS date,
        
        -- Extract market_id from event parameters
        (SELECT value.string_value 
         FROM UNNEST(ev.event_params) 
         WHERE key = 'market_id') AS market_id,
        it.item_name AS item_name,
        it.item_category AS item_category,
         
        -- Extract add_to_cart_type from item parameters
        (SELECT param.value.string_value 
         FROM UNNEST(it.item_params) AS param 
         WHERE param.key = 'add_to_cart_type') AS add_to_cart_type
         
    FROM `neogen-ga4-export.analytics_331328809.events_*` AS ev
    CROSS JOIN UNNEST(ev.items) AS it  -- Explode to item rows
    
    WHERE 
        -- Reporting window: 1 May 2025 â†’ yesterday
        _TABLE_SUFFIX BETWEEN '20250805' 
        AND FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY))
        AND (SELECT param.value.string_value 
             FROM UNNEST(it.item_params) AS param 
             WHERE param.key = 'add_to_cart_type') IN (
            'pdp',
            'quick_order', 
            'my_account_orders',
            'Search',
            'my_account_lists',
            'pcp',
            'pdp_related',
            'cms_product_carousel',
            'product_recommendations'
        )
)

SELECT 
    date,
    market_id,
    add_to_cart_type,
    item_name,
    item_category,
    
    -- Count of add_to_cart events
    COUNT(*) AS add_to_cart_events
    
FROM item_events
GROUP BY 
    date,
    market_id,
    add_to_cart_type,
     item_name,
    item_category
    
ORDER BY 
    date DESC;


